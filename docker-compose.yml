services:
  node1:
    image: hyperledger/besu:latest
    container_name: utpay-node-1
    volumes:
      - ./blockchain/networkFiles/keys/0x0bc25147c3593b8dd7c873d0a74596754226c963:/var/lib/besu/key
      - ./blockchain/networkFiles/genesis.json:/etc/besu/genesis.json
    command:
      - --genesis-file=/etc/besu/genesis.json
      - --node-private-key-file=/var/lib/besu/key/key
      - --rpc-http-enabled
      - --rpc-http-api=ETH,NET,IBFT,WEB3,DEBUG,TRACE,TXPOOL,MINER
      - --host-allowlist="*"
      - --rpc-http-cors-origins="*"
      - --rpc-http-port=8545
      - --rpc-http-host=0.0.0.0
      - --min-gas-price=0
      - --rpc-ws-enabled
      - --rpc-ws-api=ETH,NET,IBFT,WEB3,DEBUG,TRACE,TXPOOL,MINER
      - --rpc-ws-port=8546
      - --rpc-ws-host=0.0.0.0
      - --p2p-port=30303
      - --p2p-interface=0.0.0.0
    ports:
      - "8545:8545"
      - "8546:8546"
      - "30303:30303"
    networks:
      utpay_net:
        ipv4_address: 172.16.239.11

  node2:
    image: hyperledger/besu:latest
    container_name: utpay-node-2
    volumes:
      - ./blockchain/networkFiles/keys/0x4305f946854e03ed3cd92a27bb0a4b75df5e3cd4:/var/lib/besu/key
      - ./blockchain/networkFiles/genesis.json:/etc/besu/genesis.json
    command:
      - --genesis-file=/etc/besu/genesis.json
      - --node-private-key-file=/var/lib/besu/key/key
      - --rpc-http-enabled
      - --rpc-http-api=ETH,NET,IBFT,WEB3,DEBUG,TRACE,TXPOOL,MINER
      - --host-allowlist="*"
      - --rpc-http-cors-origins="*"
      - --rpc-http-port=8545
      - --rpc-http-host=0.0.0.0
      - --min-gas-price=0
      - --p2p-port=30303
      - --bootnodes=enode://7b4385317137839eb40901d3bdae93ab670ee47be439ce4c381fe2d340bc999d14372f3b297299a70333b07a5aaa5d432e6fb3888ce2568b90ab3186c8a07891@172.16.239.11:30303
    networks:
      utpay_net:
        ipv4_address: 172.16.239.12
    depends_on:
      - node1

  node3:
    image: hyperledger/besu:latest
    container_name: utpay-node-3
    volumes:
      - ./blockchain/networkFiles/keys/0x967914c00ac8a93727acd35bf73d037800d15ecf:/var/lib/besu/key
      - ./blockchain/networkFiles/genesis.json:/etc/besu/genesis.json
    command:
      - --genesis-file=/etc/besu/genesis.json
      - --node-private-key-file=/var/lib/besu/key/key
      - --rpc-http-enabled
      - --rpc-http-api=ETH,NET,IBFT,WEB3,DEBUG,TRACE,TXPOOL,MINER
      - --host-allowlist="*"
      - --rpc-http-cors-origins="*"
      - --rpc-http-port=8545
      - --rpc-http-host=0.0.0.0
      - --min-gas-price=0
      - --p2p-port=30303
      - --bootnodes=enode://7b4385317137839eb40901d3bdae93ab670ee47be439ce4c381fe2d340bc999d14372f3b297299a70333b07a5aaa5d432e6fb3888ce2568b90ab3186c8a07891@172.16.239.11:30303
    networks:
      utpay_net:
        ipv4_address: 172.16.239.13
    depends_on:
      - node1

  node4:
    image: hyperledger/besu:latest
    container_name: utpay-node-4
    volumes:
      - ./blockchain/networkFiles/keys/0x57898f715d90bf0c992c0dfa74d6e157b9819bed:/var/lib/besu/key
      - ./blockchain/networkFiles/genesis.json:/etc/besu/genesis.json
    command:
      - --genesis-file=/etc/besu/genesis.json
      - --node-private-key-file=/var/lib/besu/key/key
      - --rpc-http-enabled
      - --rpc-http-api=ETH,NET,IBFT,WEB3,DEBUG,TRACE,TXPOOL,MINER
      - --host-allowlist="*"
      - --rpc-http-cors-origins="*"
      - --rpc-http-port=8545
      - --rpc-http-host=0.0.0.0
      - --min-gas-price=0
      - --p2p-port=30303
      - --bootnodes=enode://7b4385317137839eb40901d3bdae93ab670ee47be439ce4c381fe2d340bc999d14372f3b297299a70333b07a5aaa5d432e6fb3888ce2568b90ab3186c8a07891@172.16.239.11:30303
    networks:
      utpay_net:
        ipv4_address: 172.16.239.14
    depends_on:
      - node1

  blockscout:
    image: blockscout/blockscout:6.9.1
    container_name: utpay-blockscout
    restart: always
    command: sh -c "bin/blockscout eval 'Explorer.ReleaseTasks.create_and_migrate()' && bin/blockscout start"
    environment:
      - PORT=4000
      - NETWORK=UTPay
      - SUBNETWORK=Private
      - COIN=UTP
      - ETHEREUM_JSONRPC_VARIANT=besu
      - ETHEREUM_JSONRPC_HTTP_URL=http://node1:8545
      - ETHEREUM_JSONRPC_WS_URL=ws://node1:8546
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/blockscout?ssl=false
      - REDIS_URL=redis://redis:6379/0
      - INDEXER_DISABLE_INTERNAL_TRANSACTIONS_FETCHER=true
      - INDEXER_DISABLE_PENDING_TRANSACTIONS_FETCHER=true
      - SECRET_KEY_BASE=5678901234567890123456789012345678901234567890123456789012345678
      - CHECK_ORIGIN=false
    ports:
      - "4001:4000"
    networks:
      - utpay_net
    depends_on:
      - db
      - redis
      - node1
    links:
      - db
      - redis
      - node1

  db:
    image: postgres:15
    container_name: utpay-db
    restart: always
    command: postgres -c 'max_connections=200'
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=blockscout
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - utpay_net

  redis:
    image: redis:7
    container_name: utpay-redis
    restart: always
    networks:
      - utpay_net

  sirato-mongo:
    image: mongo:5.0.8
    container_name: sirato-mongo
    environment:
      - MONGO_INITDB_DATABASE=epirus
    networks:
      - utpay_net

  sirato-api:
    image: web3labs/epirus-free-api:latest
    container_name: sirato-api
    environment:
      - NODE_ENDPOINT=http://node1:8545
      - MONGO_CLIENT_URI=mongodb://sirato-mongo:27017
      - MONGO_DB_NAME=epirus
      - SPRING_REDIS_HOST=redis
      - SPRING_DATA_REDIS_HOST=redis
      - REDIS_HOST=redis
    depends_on:
      - sirato-mongo
      - redis
    networks:
      - utpay_net

  sirato-web:
    image: web3labs/epirus-free-web:latest
    container_name: sirato-web
    environment:
      - API_URL=http://localhost:4000/api
      - WS_API_URL=ws://localhost:4000/api
    depends_on:
      - sirato-api
    networks:
      - utpay_net

  sirato-ingestion:
    image: web3labs/epirus-free-ingestion:latest
    container_name: sirato-ingestion
    environment:
      - NODE_ENDPOINT=http://node1:8545
      - MONGO_CLIENT_URI=mongodb://sirato-mongo:27017
      - MONGO_DB_NAME=epirus
      - SPRING_REDIS_HOST=redis
      - SPRING_DATA_REDIS_HOST=redis
      - REDIS_HOST=redis
    depends_on:
      - sirato-mongo
      - redis
    networks:
      - utpay_net

  sirato-nginx:
    image: nginx:latest
    container_name: sirato-nginx
    volumes:
      - ./sirato/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "4000:80"
    depends_on:
      - sirato-web
      - sirato-api
    networks:
      - utpay_net

networks:
  utpay_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.16.239.0/24
