services:
  node1:
    image: hyperledger/besu:latest
    container_name: utpay-node-1
    # Nodo Transaccional (Bonsai Mode)
    volumes:
      - ./blockchain/networkFiles/keys/0x0bc25147c3593b8dd7c873d0a74596754226c963:/var/lib/besu/key
      - ./blockchain/networkFiles/genesis.json:/etc/besu/genesis.json
    command:
      - --genesis-file=/etc/besu/genesis.json
      - --node-private-key-file=/var/lib/besu/key/key
      - --data-storage-format=BONSAI
      - --rpc-http-enabled
      - --rpc-http-api=ETH,NET,IBFT,WEB3,DEBUG,TRACE,TXPOOL,MINER,ADMIN
      - --host-allowlist="*"
      - --rpc-http-cors-origins="*"
      - --rpc-http-port=8545
      - --rpc-http-host=0.0.0.0
      - --min-gas-price=0
      - --rpc-ws-enabled
      - --rpc-ws-api=ETH,NET,IBFT,WEB3,DEBUG,TRACE,TXPOOL,MINER
      - --rpc-ws-port=8546
      - --rpc-ws-host=0.0.0.0
      - --p2p-port=30303
      - --p2p-interface=0.0.0.0
    ports:
      - "8545:8545"
      - "8546:8546"
      - "30303:30303"
    networks:
      utpay_net:
        ipv4_address: 172.16.239.11

  node2:
    image: hyperledger/besu:latest
    container_name: utpay-node-2
    # Nodo Transaccional (Bonsai Mode)
    volumes:
      - ./blockchain/networkFiles/keys/0x4305f946854e03ed3cd92a27bb0a4b75df5e3cd4:/var/lib/besu/key
      - ./blockchain/networkFiles/genesis.json:/etc/besu/genesis.json
    command:
      - --genesis-file=/etc/besu/genesis.json
      - --node-private-key-file=/var/lib/besu/key/key
      - --data-storage-format=BONSAI
      - --rpc-http-enabled
      - --rpc-http-api=ETH,NET,IBFT,WEB3,DEBUG,TRACE,TXPOOL,MINER,ADMIN
      - --host-allowlist="*"
      - --rpc-http-cors-origins="*"
      - --rpc-http-port=8545
      - --rpc-http-host=0.0.0.0
      - --min-gas-price=0
      - --p2p-port=30303
      - --bootnodes=enode://7b4385317137839eb40901d3bdae93ab670ee47be439ce4c381fe2d340bc999d14372f3b297299a70333b07a5aaa5d432e6fb3888ce2568b90ab3186c8a07891@172.16.239.11:30303
    networks:
      utpay_net:
        ipv4_address: 172.16.239.12
    depends_on:
      - node1

  node3:
    image: hyperledger/besu:latest
    container_name: utpay-node-3
    # Nodo Transaccional (Bonsai Mode)
    volumes:
      - ./blockchain/networkFiles/keys/0x967914c00ac8a93727acd35bf73d037800d15ecf:/var/lib/besu/key
      - ./blockchain/networkFiles/genesis.json:/etc/besu/genesis.json
    command:
      - --genesis-file=/etc/besu/genesis.json
      - --node-private-key-file=/var/lib/besu/key/key
      - --data-storage-format=BONSAI
      - --rpc-http-enabled
      - --rpc-http-api=ETH,NET,IBFT,WEB3,DEBUG,TRACE,TXPOOL,MINER,ADMIN
      - --host-allowlist="*"
      - --rpc-http-cors-origins="*"
      - --rpc-http-port=8545
      - --rpc-http-host=0.0.0.0
      - --min-gas-price=0
      - --p2p-port=30303
      - --bootnodes=enode://7b4385317137839eb40901d3bdae93ab670ee47be439ce4c381fe2d340bc999d14372f3b297299a70333b07a5aaa5d432e6fb3888ce2568b90ab3186c8a07891@172.16.239.11:30303
    networks:
      utpay_net:
        ipv4_address: 172.16.239.13
    depends_on:
      - node1

  node4:
    image: hyperledger/besu:latest
    container_name: utpay-node-4
    # Nodo Hist√≥rico (Archive Node / Forest Mode)
    volumes:
      - ./blockchain/networkFiles/keys/0x57898f715d90bf0c992c0dfa74d6e157b9819bed:/var/lib/besu/key
      - ./blockchain/networkFiles/genesis.json:/etc/besu/genesis.json
    command:
      - --genesis-file=/etc/besu/genesis.json
      - --node-private-key-file=/var/lib/besu/key/key
      - --data-storage-format=FOREST
      - --rpc-http-enabled
      - --rpc-http-api=ETH,NET,IBFT,WEB3,DEBUG,TRACE,TXPOOL,MINER,ADMIN
      - --host-allowlist="*"
      - --rpc-http-cors-origins="*"
      - --rpc-http-port=8545
      - --rpc-http-host=0.0.0.0
      - --min-gas-price=0
      - --p2p-port=30303
      - --bootnodes=enode://7b4385317137839eb40901d3bdae93ab670ee47be439ce4c381fe2d340bc999d14372f3b297299a70333b07a5aaa5d432e6fb3888ce2568b90ab3186c8a07891@172.16.239.11:30303
    networks:
      utpay_net:
        ipv4_address: 172.16.239.14
    depends_on:
      - node1

  # 1. Base de Datos para el Explorador (PostgreSQL)
  blockscout-db:
    image: postgres:14
    container_name: utpay-explorer-db
    environment:
      POSTGRES_USER: blockscout
      POSTGRES_PASSWORD: password
      POSTGRES_DB: blockscout
      POSTGRES_HOST_AUTH_METHOD: trust
    volumes:
      - blockscout-db-data:/var/lib/postgresql/data
    networks:
      utpay_net:
        ipv4_address: 172.16.239.20

  # 2. El Explorador Blockscout (Frontend + Backend)
  blockscout:
    image: blockscout/blockscout:latest
    container_name: utpay-explorer
    command: ["/bin/sh", "-c", "bin/blockscout eval 'Explorer.ReleaseTasks.create_and_migrate()' && bin/blockscout start"]
    depends_on:
      - blockscout-db
      - node4
    ports:
      - "4001:4000"
    environment:
      - PORT=4000
      - SECRET_KEY_BASE=5678901234567890123456789012345678901234567890123456789012345678
      - DATABASE_URL=postgresql://blockscout:password@blockscout-db:5432/blockscout?ssl=false
      - ECTO_USE_SSL=false
      - ETHEREUM_JSONRPC_VARIANT=besu
      - ETHEREUM_JSONRPC_HTTP_URL=http://node4:8545
      - ETHEREUM_JSONRPC_TRACE_URL=http://node4:8545
      - COIN=UTP
      - NETWORK=UTPay
      - SUBNETWORK=Smart Campus
      - SHOW_PRICE_CHART=false
      - DISABLE_EXCHANGE_RATES=true
      - INDEXER_DISABLE_INTERNAL_TRANSACTIONS_FETCHER=true
      - FRONTEND_ENABLED=true
    networks:
      utpay_net:
        ipv4_address: 172.16.239.21

  blockscout-frontend:
    image: ghcr.io/blockscout/frontend:latest
    container_name: utpay-explorer-frontend
    depends_on:
      - blockscout
    ports:
      - "4000:3000"
    environment:
      - NEXT_PUBLIC_NETWORK_NAME=UTPay
      - NEXT_PUBLIC_NETWORK_ID=2026
      - NEXT_PUBLIC_NETWORK_RPC_URL=http://localhost:8545
      - NEXT_PUBLIC_IS_TESTNET=true
      - NEXT_PUBLIC_API_PROTOCOL=http
      - NEXT_PUBLIC_API_HOST=localhost
      - NEXT_PUBLIC_API_PORT=4001
      - NEXT_PUBLIC_APP_PROTOCOL=http
      - NEXT_PUBLIC_APP_HOST=localhost
      - NEXT_PUBLIC_APP_PORT=4000
    networks:
      utpay_net:
        ipv4_address: 172.16.239.22

networks:
  utpay_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.16.239.0/24

volumes:
  blockscout-db-data:
